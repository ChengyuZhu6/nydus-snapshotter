FROM alpine:3.17.0 AS sourcer

ARG NYDUS_VER=v2.1.5

RUN apk add --no-cache curl && \
    apk add --no-cache --upgrade grep && \
    wget https://github.com/dragonflyoss/nydus/releases/download/$NYDUS_VER/nydus-static-$NYDUS_VER-linux-amd64.tgz && \
    echo $NYDUS_VER > /.nydus_version && \
    tar xzf nydus-static-$NYDUS_VER-linux-amd64.tgz && \
    rm nydus-static-$NYDUS_VER-linux-amd64.tgz && \
    mv nydus-static/* /

FROM alpine:3.17.0

WORKDIR /root/
RUN apk add --no-cache libc6-compat bash jq gcompat

VOLUME /var/lib/containerd-nydus /run/containerd-nydus

COPY --from=sourcer /.nydus_version /.nydus_version

RUN mkdir -p /usr/bin/ /opt/nydus/ /var/lib/containerd-nydus/cache /tmp/blobs/
COPY --from=sourcer /nydus* /usr/bin/
COPY containerd-nydus-grpc /usr/bin/
COPY snapshotter.sh /opt/nydus/snapshotter.sh
RUN chmod +x /usr/bin/containerd-nydus-grpc /opt/nydus/snapshotter.sh
COPY nydusd-config.fusedev.json /etc/nydus/nydusd-fusedev.json
COPY nydusd-config-localfs.json /etc/nydus/nydusd-localfs.json
COPY nydusd-config.fscache.json /etc/nydus/nydusd-fscache.json
COPY config.toml /etc/nydus/config.toml

COPY entrypoint.sh /

ENTRYPOINT ["/entrypoint.sh"]
